<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>海巡軍正43期-期中考</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Diff Match Patch Library (Google) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/diff_match_patch/20121119/diff_match_patch.js"></script>
    <!-- Mermaid JS for Diagrams -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; background-color: #f0f2f5; }
        .main-container { max-width: 900px; margin: 30px auto; padding: 20px; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .btn-xl { padding: 10px 20px; font-size: 1.1rem; border-radius: 8px; }
        
        /* 差異樣式設定 */
        .diff-ins { 
            color: #dc3545; /* 紅色 */
            text-decoration: line-through; /* 刪除線 (多餘/錯誤) */
            font-weight: bold;
            background-color: #ffe6e6; 
            padding: 0 2px; 
            border-radius: 3px; 
        } 
        
        /* 缺漏樣式：藍色底色 */
        .diff-missing { 
            color: #0d6efd; 
            font-weight: bold; 
            background-color: #e7f1ff; 
            padding: 2px 4px; 
            border-radius: 4px; 
            border: 1px dashed #0d6efd;
        } 
        
        .result-box { white-space: pre-wrap; word-break: break-all; font-size: 1rem; line-height: 1.8; }
        .card-header-custom { background: linear-gradient(45deg, #2c3e50, #4ca1af); color: white; border-radius: 12px 12px 0 0 !important; }
        .badge-type { font-size: 0.9rem; padding: 6px 10px; }
        .badge-cat { font-size: 0.8rem; padding: 5px 8px; margin-right: 5px; }
        .bg-law { background-color: #6f42c1; color: white; } /* 法律紫色 */
        .bg-pro { background-color: #20c997; color: white; } /* 專業青色 */

        #statsArea { display: none; transition: all 0.5s; }
        #quizArea { display: none; }
        #reviewArea { display: none; } 
        .step-indicator { font-size: 0.9rem; color: #6c757d; margin-bottom: 5px; }
        
        /* Table styles for diff */
        .diff-table th { width: 15%; white-space: nowrap; vertical-align: top; background-color: #f8f9fa; }
        .diff-table td { vertical-align: top; }
        
        /* Review item style */
        .review-item { border-left: 4px solid #0d6efd; background-color: #fff; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .review-q { font-weight: bold; color: #333; margin-bottom: 12px; font-size: 1.1rem; }
        .review-a-container { margin-top: 15px; padding-top: 15px; border-top: 1px dashed #ccc; }
        .review-a-text { color: #555; white-space: pre-wrap; line-height: 1.6; }
        .review-practice-area { background-color: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 10px; }
        .diff-result-mini { margin-top: 10px; padding: 10px; background-color: #fff; border: 1px solid #dee2e6; border-radius: 5px; }
        
        /* Diagram Container */
        .diagram-wrapper {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            margin-top: 15px;
            text-align: center;
            overflow: hidden; /* 防止溢出 */
        }
        .zoom-controls {
            margin-bottom: 10px;
            background: #f8f9fa;
            padding: 5px 15px;
            border-radius: 20px;
            display: inline-block;
        }
        .zoom-controls input {
            width: 150px;
            vertical-align: middle;
            margin-left: 10px;
        }
        .mermaid {
            transform-origin: top center;
            transition: transform 0.1s ease-out;
        }

        /* Animation for menu transitions */
        .animate-fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="main-container">
        <div class="text-center mb-4">
            <h2 class="fw-bold text-primary">👮‍♂️ 海巡軍正43期-期中考</h2>
            <p class="text-muted">題庫分類版 (含流程圖) | 隨機測驗 & 類型篩選</p>
        </div>

        <!-- Control Panel -->
        <div id="controlPanel" class="card mb-4 border-0 shadow-sm">
            <div class="card-body bg-light rounded-3">
                <div class="step-indicator">功能選單</div>
                
                <!-- Main Menu Buttons (Step 1) -->
                <div id="mainMenu" class="d-flex flex-wrap gap-2 justify-content-center mt-3 animate-fade-in">
                    <button id="btnImport" class="btn btn-outline-secondary" disabled>✅ 題庫已自動載入</button>
                    <button id="btnReset" class="btn btn-danger">🔄 全部重設 (Reset)</button>
                    <button id="btnReview" class="btn btn-info text-white">📖 完整題庫與練習</button>
                    <button id="btnStartMode" class="btn btn-primary btn-xl px-5">🚀 隨機測驗模式</button>
                </div>

                <!-- Category Selection Menu (Step 2 - Hidden by default) -->
                <div id="categoryMenu" style="display:none;" class="mt-4 text-center animate-fade-in">
                    <h5 class="mb-4 text-secondary fw-bold">🎯 請選擇測驗類型以開始出題：</h5>
                    <div class="d-flex gap-3 justify-content-center flex-wrap">
                        <button class="btn btn-outline-dark btn-lg px-4" onclick="startQuiz('all')">📚 全部 (All)</button>
                        <button class="btn btn-outline-primary btn-lg px-4" onclick="startQuiz('法律')">⚖️ 法律</button>
                        <button class="btn btn-outline-success btn-lg px-4" onclick="startQuiz('專業')">⚓ 專業</button>
                    </div>
                    <div class="mt-3">
                        <button class="btn btn-link text-muted" onclick="showMainMenu()">⬅️ 返回主選單</button>
                    </div>
                </div>
                
                <!-- Stats Display -->
                <div id="statsArea" class="alert alert-success mt-4 text-center mx-auto" style="max-width: 600px;">
                    <h5 class="alert-heading mb-2">📚 題庫匯入完成！</h5>
                    <div class="d-flex justify-content-center gap-4">
                        <span>📝 題目總數：<strong id="countTotal" class="fs-5">0</strong> 題</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quiz Area (Random Mode) -->
        <div id="quizArea">
            <div class="card border-0 shadow">
                <div class="card-header card-header-custom d-flex justify-content-between align-items-center p-3">
                    <div>
                        <span id="qCategoryBadge" class="badge badge-cat me-1">分類</span>
                        <span id="qTypeBadge" class="badge bg-warning text-dark badge-type me-2">問答/申論</span>
                        <span class="text-white-50 small">隨機出題模式</span>
                    </div>
                    <span id="qProgress" class="badge bg-light text-dark">剩餘題目: 0</span>
                </div>
                
                <div class="card-body p-4">
                    <!-- Question -->
                    <h5 class="card-title text-secondary mb-3">題目：</h5>
                    <div class="alert alert-light border border-secondary border-opacity-25 shadow-sm">
                        <h4 id="questionText" style="line-height: 1.5; white-space: pre-wrap;">題目載入中...</h4>
                    </div>
                    
                    <!-- Answer Input -->
                    <div class="mb-3 mt-4">
                        <label for="userAnswer" class="form-label fw-bold text-primary">✍️ 您的答案：</label>
                        <div class="form-text mb-2">請注意：答案中的項次編號（如 1、 2、 (1)、一、二）均列入比對範圍，請務必輸入。</div>
                        <textarea class="form-control fs-5" id="userAnswer" rows="8" placeholder="請在此輸入答案..."></textarea>
                    </div>

                    <!-- Submit Button -->
                    <div class="d-grid gap-2" id="actionArea">
                        <button id="btnSubmit" class="btn btn-success btn-xl shadow-sm">送出答案並比對</button>
                    </div>

                    <!-- Result Area -->
                    <div id="resultArea" class="mt-4 animate__animated animate__fadeIn" style="display:none;">
                        <div class="card border-info">
                            <div class="card-header bg-info text-white fw-bold">📊 比對結果</div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-bordered mb-0 diff-table">
                                        <tbody>
                                            <tr>
                                                <th class="text-end">標準答案</th>
                                                <td class="result-box bg-light text-secondary" id="resStandard"></td>
                                            </tr>
                                            <tr>
                                                <th class="text-end">您的答案</th>
                                                <td class="result-box" id="resUser"></td>
                                            </tr>
                                            <tr class="table-warning">
                                                <th class="text-end text-dark">差異分析<br><span class="badge bg-secondary badge-type">標點忽略</span></th>
                                                <td class="result-box bg-white" id="resDiff"></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="card-footer bg-white border-top-0 p-3">
                                <div class="alert alert-secondary py-2 small mb-0">
                                    <i class="bi bi-info-circle"></i> 說明：<span class="diff-ins">紅色刪除線</span> 代表多餘或錯誤的內容；<span class="diff-missing">藍色底色文字</span> 代表您漏掉的標準答案內容（含編號）。黑色的標點符號代表系統已忽略其差異。
                                </div>
                                <!-- Next Button -->
                                <div class="d-grid mt-3">
                                    <button id="btnNext" class="btn btn-outline-primary btn-lg">➡️ 下一題 (Next)</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Review Area (Practice Mode) -->
        <div id="reviewArea">
            <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                <h4 class="fw-bold text-dark"><i class="bi bi-book"></i> 完整題庫與練習</h4>
                <div class="d-flex gap-2 align-items-center">
                    <!-- Filter Controls -->
                    <div class="btn-group" role="group" aria-label="Category Filter">
                        <input type="radio" class="btn-check" name="catFilter" id="filterAll" value="all" checked onchange="filterQuestions('all')">
                        <label class="btn btn-outline-secondary" for="filterAll">全部</label>

                        <input type="radio" class="btn-check" name="catFilter" id="filterLaw" value="法律" onchange="filterQuestions('法律')">
                        <label class="btn btn-outline-primary" for="filterLaw">法律</label>

                        <input type="radio" class="btn-check" name="catFilter" id="filterPro" value="專業" onchange="filterQuestions('專業')">
                        <label class="btn btn-outline-success" for="filterPro">專業</label>
                    </div>

                    <div class="vr mx-2"></div>

                    <button id="btnToggleAll" class="btn btn-sm btn-outline-dark">全部顯示/隱藏答案</button>
                    <button id="btnBackFromReview" class="btn btn-sm btn-dark">⬅️ 返回</button>
                </div>
            </div>
            <div class="alert alert-info py-2 small">
                <i class="bi bi-info-circle"></i> 提示：點擊上方按鈕可篩選題目類型。點擊每題下方的「隱藏答案」進行自我練習。
            </div>
            <div id="reviewContent">
                <!-- Javascript will populate this -->
            </div>
        </div>

    </div>
</div>

<script>
// 初始化 Mermaid
mermaid.initialize({ startOnLoad: true, theme: 'default', securityLevel: 'loose' });

/**
 * 內建題庫資料 (已加入分類標籤)
 * 格式：[Type:類型|Category:分類]
 */
const rawDataString = `
[Type:簡答題|Category:法律]
1. 訊問拘捕被告時告知事項為何?
答：
1、告知罪名。
2、得行使緘默權。
3、得選任辯護人。
4、得請求調查有利之證據

[Type:簡答題|Category:法律]
2. 刑事訴訟法對現行犯的定義?
答：
刑事訴訟法第88條規定:
現行犯,不問何人得逕行逮捕之。
犯罪在實施中或實施後即時發覺者,為現行犯。
有左列情形之一者,以現行犯論:
1、被追呼為犯罪人者。
2、因持有兇器、贓物或其他物件,或於身體、衣服等處露有犯罪痕跡,顯可疑為犯罪人者。

[Type:簡答題|Category:法律]
3. 何謂告訴乃論之罪?
答：
1、告訴乃論之罪,係指有告訴權人,向司法機關申告犯罪事實並表示訴追之意思表示,始得審判訴追之罪。
2、告訴乃論之罪依情形可分為兩種,絕對告訴乃論之罪及相對告訴乃論之罪,前者著重於犯罪事實,凡是觸犯各該罪時,不論犯人身分為何,均須告訴乃論;後者著重於犯人,必須具有一定之身分者,始須告訴乃論,否則僅屬於非告訴乃論之罪,此類犯罪必須告訴人除申告犯罪事實表示訴追意思外,並表明犯人始得訴追。

[Type:簡答題|Category:法律]
4. 偵查中檢察官、檢察事務官、司法警察官或司法警察訊問被告或犯罪嫌疑人時,辯護人得在場並陳述意見。但何種情形下,得限制或禁止辯護人之在場權?
答：
依刑事訴訟法第245條第2項,有事實足認其在場有妨害國家機密或有湮滅、偽造、變造證據或勾串共犯或證人或妨害他人名譽之虞,或其行為不當足以影響偵查秩序者。

[Type:申論題|Category:法律]
5. 請簡述何謂無罪推定原則?對訴訟制度的影響?
答：
「無罪推定原則」是國際公認的刑事訴訟基本原則,我國刑事訴訟法第一百五十四條第一項規定:「被告未經審判證明有罪確定前,推定其為無罪。」即揭示此一原則。其核心意義包括:
1、被告人在刑事訴訟程序中被推定為無罪,直到檢察官提出足夠證據並經法院審判程序證明有罪為止。
2、舉證責任在於檢察官,被告人無義務證明自己無罪。
3、對被告人的犯罪事實存在合理懷疑時,應作出有利於被告人的認定。
4、保護被告人基本人權,防止無辜者遭受不當刑事處罰。
5、適用於整個刑事訴訟程序,包括偵查和審判階段。

[Type:簡答題|Category:法律]
6. 請述比例原則之內涵為何?請以「殺雞」與「取卵」分析,何時不具有適當性?
答：
關於行政之方法與目的間應具有比例考量,依據行政程序法第7條之規定如下:
適當性原則:採取之方法應有助於目的之達成。
必要性原則:有多種同樣能達成目的之方法時,應選擇對人民權益損害最少者。
狹義比例原則:採取之方法所造成之損害不得與欲達成目的之利益顯失均衡。
當殺的是公雞、小雞、沒在下蛋的母雞時,因該殺雞無法取得卵,故是違反適當性原則,故不符合比例原則。

[Type:簡答題|Category:法律]
7. 依據《行政罰法》第18條行政機關執行處罰裁量時,所應考慮之因素?
答：
裁處罰鍰,應審酌違反行政法上義務行為
1、應受責難程度。
2、所生影響。
3、因違反行政法上義務所得之利益。
4、考量受處罰者之資力。

[Type:簡答題|Category:法律]
8. 防疫視同作戰的最高指導原則?
答：
1、最高標準。
2、最嚴謹的態度。
3、長期作戰準備。
4、寧可多做、不可少做。

[Type:簡答題|Category:法律]
9. 例舉3項防範非洲豬瘟勤務作為?
答：
1、對進港船舶實施100%安全檢查。
2、建立高風險船舶名冊,提供相關單位共同監控。
3、加強海峽中線由西往東或偏離律定航道可疑目標之攔查。
4、利用雷達、守望、巡邏及高科技偵蒐裝備,建構綿密監控機制。
5、針對遠洋、活魚運搬、可疑目標及自高風險國家啟航等船舶,加強安檢力度。
6、從金馬澎地區運送至臺灣本島之包裹、貨物及冷凍櫃,執行安檢時應提高警覺。
7、針對曾發生海漂豬隻屍體及垃圾易蝟集處,配合漲潮、洋流等資訊,加強注意是否有豬隻屍體。

[Type:簡答題|Category:法律]
10. 走私禽鳥及處理相關人員之健康管理查獲走私活禽鳥類接觸人員作業注意事項為何?
答：
1、即刻通報:當地衛生單位。
2、處理過程:全程穿戴防護設備處理完畢。
3、確實清潔消毒:人員及場地。。
4、檢送接觸人員名冊:當地衛生單位
5、自主健康管理:7天。

[Type:申論題|Category:法律]
11. 請說明於岸際發現豬隻屍體應如何處置?另說明如何拉設封鎖線?
答：
1、保持現狀,拉起封鎖線管制人員進出,將現場發現豬隻屍體之區域、數量及時間等資訊通報當地防疫局派員到場處理,並檢視周遭有無其他豬隻屍體。
2、封鎖線拉設分為三線四區如下,另第一二區人員需著全套防護裝備。
(1)第一區:物品取樣、封包、焚燒、掩埋及消毒工作。
(2)第二區:指揮區域。
(3)第三區:新聞媒體採訪及攝影區域。
(4)第四區:圍觀民眾。

[Type:簡答題|Category:法律]
12. 《國家安全法》為海巡署執行「安全檢查」重要依據。請說明海巡機關於必要時,依法得對哪些對象實施檢查?
答：
1、依據《國家安全法》第5條,警察或海岸巡防機關於必要時,對左列人員、物品及運輸工具,得依其職權實施檢查:
(1)入出境之旅客及其所攜帶之物件。
(2)入出境之船舶、航空器或其他運輸工具。
(3)航行境內之船筏、航空器及其客貨。
(4)前二款運輸工具之船員、機員、漁民或其他從業人員及其所攜帶之物件。
2、對前項之檢查,執行機關於必要時,得報請行政院指定國防部命令所屬單位協助執行之。

[Type:簡答題|Category:法律]
13. 灰色地帶操作領域及定義為何?
答：
1、操作領域:軍事、外交、法律、資訊、與論、貿易與心理戰等。
2、定義:美國國防部《2018國防戰略》:敵對勢力將以非武裝衝突方式,包括掠奪式經濟、宣傳、政治顛覆、代理人以及武力威脅等改變既有事實。

[Type:簡答題|Category:專業]
14. 我國搜救責任區為何?
答：
依《行政院國家搜救指揮中心作業手冊》規定,我國搜救任務範圍以「臺北飛航情報區」區內為原則,臺灣海峽中線以西與中國大陸管轄區域重疊部分,除我國管轄區域外,原則以通知方式協請大陸有關單位辦理。

[Type:簡答題|Category:專業]
15. 依「海洋委員會海巡署應變中心作業要點」所訂,本署海難應變中心開設權責區分為何?
答：
1、本署:我國臺北飛航情報區內發生海難事故估計有十五人以上傷亡、失蹤,災害有擴大之虞,經研判有開設必要者。
2、分署:五人以上、未達十五人傷亡、失蹤或災害有擴大之虞時,轄管各分署及相鄰地區之分署視實際需要開設應變中心。
3、巡防區:未達五人傷亡或失蹤時,由轄管各分署指導巡防區指揮部專案應變,並得請求艦隊分署(各機動海巡隊)支援。

[Type:申論題|Category:專業]
16. 貴官為烏石港安檢所留守主管,於颱風來襲時,發現外澳沙灘有一名衝浪客在戲水,請問貴官如何處置?請依據「勤務執行標準作業程序」將相關流程圖繪出,並引用相關法令;並請說明你認為未來在海巡「勤務執行標準作業程序」那些環節式適合導入AI輔助,可能帶來哪些風險與效益?
答：
1、各岸巡隊於接獲縣(市)政府警戒區域劃定通報後應即指揮所屬巡防人員,執行海岸、港口警戒區域內海釣管制、臨海海面查察及人員、車船入出等管制工作,執行前各級幹部應嚴格要求執勤人員穿著救生衣。
2、颱風期間發現有未劃定警戒區域者,應主動協調縣(市)政府公告劃定,若縣(市)政府仍未劃定警戒區域,應立即循各單位勤務指揮系統回報至海巡署勤指中心,轉報中央災害應變中心。
3、縣(市)政府依災害防救法第30條第1項第2、3款劃定警戒區域:
(1)對欲違反規定之民眾,在狀況許可下,應善盡勸導責任,並以言詞告知該地區業經縣(市)政府劃定公告為警戒區域,違法進入或逗留,依災害防救法第55條第2、3款,可處新臺幣5萬元以上25萬元以下罰鍰外,另將予強制執行。
(2)如民眾仍欲進入或繼續於岸際、港口等警戒區域逗留觀浪、撿拾漂流木或從事釣魚等活動,應立即開立違反災害防救法勸導書表給予當事人,經勸導仍不聽從者,除開立舉發單,並依違反災害防救法第30條第1項第2、3款檢具相關事證(相片、錄音、錄影帶)函送縣(市)政府,另依行政執行法第27、28及32條,採取直接強制手段禁止其進入或命其離去,惟仍應注意比例原則之適用。
(3)視現場狀況,向地方縣(市)政府應變中心指揮官反應,請其調派能量共同執行相關勸導、舉發及函送等作為。
4、若縣(市)政府未劃定警戒區域,巡防機關執勤人員衡量當時客觀情狀(明白而立即危險)認定有急迫危險,符合行政執行法第36、37及39條,得採取即時強制手段禁止其進入或命其離去,惟仍應注意比例原則之適用。
注意事項:
1、各單位應依地方政府災害應變實際需要,在不影響本署既有勤(任)務情形於警戒區域內執行行政協助事項。
2、執勤人員應著救生衣、攜帶哨子、擴音器等器材,實施勸導時應視情況使用哨子、擴音器等器材確實令民眾知悉勸導內容,並須注意態度,口氣和緩,避免造成口角。
3、確實運用港區監控系統或其他蒐證器材實施蒐證,並將勸導內容及執法情形全程實施錄音(影)存證,以作為後續佐證資料。
(流程處置)
見下方流程圖

[Type:簡答題|Category:專業]
17. 貴官於巡防區勤務指揮中心擔任執勤員時,應與雷達作業組共同複視監控轄區海面目標,請試舉5種海面可疑目標徵候？
答：
1、由外海駛向岸際之目標。
2、沿岸航行之目標。
3、尾隨、併靠、接駁之目標。
4、航艇艦追緝之目標。
5、多點成線或時有時無之小型(不明)目標。

[Type:簡答題|Category:專業]
18. 貴官於勤務指揮中心擔任執勤員時,接獲雷達作業組回報,雷達於12浬外發現一目標持續向岸際移動,依據海岸巡防總局岸際雷達監偵海面可疑目標狀況處置要領,應如何處置？
答：
由外海駛向岸際(即外切)目標處置如下:
1、均列為可疑目標,全數鎖定、管制。
2、依目標航跡及航速,預判到達岸際時間、位置,並回報巡防區執勤官(員)依據目標後續動向適時通報岸、海勤務單位採取至當勤務作為。
3、就目標當時距岸遠近,運用通聯器材,主動通報各機動巡邏站、岸置守望、督導兼巡邏組,發掘岸、港、澳可疑徵兆;另視目標於海上有無可疑徵候,通報責任區在航勤務艦艇前往執檢勤務。
4、隨時掌握目標動態,並於每15分鐘記錄處置作為。

[Type:簡答題|Category:專業]
19. 雷達之外在因素干擾有哪些?請列舉五項。
答：
1、自然現象產生之反射信號。
2、地面反射信號。
3、地球曲度。
4、系統產生之假回跡。
5、抑制雜波。
6、目標形狀。
7、目標材質。
8、障礙物之高度。
9、天線高度。
10、天線配置之長短與間距。

[Type:申論題|Category:專業]
20. 雷達作業組依據岸際雷達偵獲目標之遠近鎖定上傳雷情系統,貴官擔任巡防區指管長,依據雷情傳遞作業責任區劃分哪些勤務區塊?
答：
1、距岸3浬至岸港(澳):
(1)巡防區指導雷達作業組協同岸際守望與安檢人員,共同掌握目標海上與進(出)港相關動態。
(2)依預警情資與雷情研判,由巡防區通報責任區所屬在航勤務艦艇對海面威脅及可疑目標採取執檢措施,並轉報海巡隊協處。
(3)岸巡隊及勤務區塊依當日勤務規劃,要求港岸督導兼巡邏組之勤務人員,加強責任區監視,並適時通報投入查緝勤務。
2、距岸6浬至3浬之水域:
(1)巡防區指導雷達作業組協同岸際守望監控範圍,共同掌握目標海上動態。
(2)依預警情資與雷情研判,由各級勤指中心通報責任區在航勤務艇就重點目標採取相關執檢措施。
(3)就目標後續動向及徵候,由巡防區通報所屬岸巡隊及勤務區塊要求各所、站完成機動支援人力整備,適時投入單位查緝工作。
3、距岸12浬至6浬之水域:
依預警情資與雷情研判,由各級勤務指揮中心通報在航勤務艦艇及空中勤務總隊直升機執行相關執檢、監視措施,並由巡防區指導雷達作業組協同掌握目標後續動向,共同查處。
4、距岸12浬以外至雷達最大偵蒐距離範圍內之水域:
由雷達作業組對國(內)外航線之船舶動態適切擴大偵蒐,必要時(如海上援救)由各級勤務指揮中心通報在航勤務艦艇、空中勤務總隊直升機採取至當勤務作為,並轉(回)報相關單位協處。

[Type:簡答題|Category:專業]
21. 在執行驅離或登檢勤務時,面對不配合的目標船,指揮官下令使用「強制力」(如高壓水泵或器械)的核心前提為何?而在何種情況下必須立即停止使用?(請依據比例原則作答)
答：
1、啟動前提:須在「已先行告誡」且「無法以其他和平手段達成任務」(如廣播無效)時,始得使用,且不得逾越達成目的之必要程度。
2、終止時機:當「執法目的已達成」(如對方停船或離開水域)或「威脅行為已消滅」時,應立即停止使用,避免執法過當衍生法律責任。

[Type:簡答題|Category:專業]
22. 巡防機關執行海上救難搜救任務停止原則為何?
答：
1、失事位置確定且人員生還可能性消失,或水溫攝氏21度以下搜救48小時及攝氏21度以上搜救72小時未果者,即可停止搜救任務。(搜救起始時間,係以遇難發生起算,倘無法確定遇難發生時間,則以接獲第一次通報時起算)。
2、經研判有持續搜救必要者,得依令延長任務時間。

[Type:簡答題|Category:專業]
23. 請問「預置兵力」的定義?
答：
指單位接獲預警情資或預判狀況發生之前所採取之勤務作為要領如下:
1、通報鄰近單位就近就便應處。
2、視當前狀況進展,預判可能發生之事件,預先完成機動支援之勤務人力、裝備、器材及車輛之整備,並預置於狀況可能發生之地點附近,以利狀況發生時立即投入。

[Type:簡答題|Category:專業]
24. 海岸巡防機關執行漁港安全檢查之法律依據為何?
答：
1、國家安全法。
2、國家安全法施行細則。
3、海岸巡防法。

[Type:簡答題|Category:專業]
25. 請問海巡「勤務攔截部署」的概念?
答：
指兵力由內往外建立多重部署攔截網(初期、中程及擴大攔截等3層),拘束在特定地點後,形成包圍態勢,遂行掃蕩之概念。

[Type:簡答題|Category:專業]
26. 目標監控應處原則為何?
答：
目標監偵處置,應就「偵知」、「辨識」、「掌握」、「採取措施」等執行程序,確實完成目標偵獲與研判,爭取反應縱深,達到提早預警之功效。

[Type:簡答題|Category:專業]
27. 「三道監偵幕」係由巡防區藉由4CISR建立指揮管理系統,請問4CISR所指為何?
答：
1、指揮(Command)
2、管制(Control)
3、通信(communication)
4、資訊(computers)、情報(Intelligence)
5、監視(Surveillance)
6、偵察(Reconnaissance)。

[Type:簡答題|Category:專業]
28. 請列舉外國船舶或其他水上運輸工具,因緊急情形需進入港口情況為何?
答：
1、船舶已失去航行能力,無法在海上自行修復者。
2、船舶載運人員重大傷病,有生命危險之虞者。
3、發生風災等重大災害或海況惡劣有安全顧慮者。
4、其他不可抗力或緊急狀況需進港者。

[Type:簡答題|Category:專業]
29. 巡防區每季對於轄區船舶及其他運輸工具實施船舶評鑑分類,乙類對象內容為何?
答：
乙類對象:無違法紀錄,但最近三年內情資顯示或曾因安檢發現下列情形之一者:
1、漁船(筏)船體、輪機等疑有擅自變更或有變更之跡象。
2、攜帶與漁業證照不符之漁具或可資採捕水產動植物之器材並疑有有使用之跡象。
3、經常有部分船員未事先完成僱用手續。
4、經常發現本國籍幹部船員配置不足。
5、疑有涉及走私、偷渡、違反安全、漁業資源維護、海洋環境保護及保育等法令之其他跡象。

[Type:申論題|Category:專業]
30. 海岸巡防機關執行法定之檢查業務,請說明海巡機關人員實施港區船舶檢查方式為何?
答：
1、海巡機關人員於港區實施船舶檢查前,應事先蒐集、檢視受檢船舶之相關資料,足認其有可疑而有違法之虞時,始發動檢查。
2、對於入出港或於航道航行之船舶認有可疑而有違法之虞者,以手勢、警示燈、紅色旗幟、哨音或其他輔助方式要求其停船接受檢查,如該船舶無減速跡象,得重複警示要求停船泊靠碼頭受檢。
3、對於不遵守停船命令之船舶,船舶出港時應即實施蒐證及通報鄰近雷達、守望哨掌握船舶動態,並通知海巡隊在航艦艇前往登臨檢查;船舶入港時則加強檢查力度,並同步實施蒐證。
4、執行檢查前,檢查人員應向受檢船舶船長或代理行表明身分,說明檢查之依據及理由後,由該船長或其指定人員陪同檢查。
5、船舶檢查之範圍,應依船舶大小、種類、狀況、船員行為及潛在危險而定。
6、受檢查船舶之人員不具威脅性時,應以柔性方式召集檢查,經檢查完畢後,應允許其自由活動。
7、檢查過程發現可疑情形,有正當理由認有違法之虞時,始得會同船員檢查私人空間與物品。

[Type:簡答題|Category:法律]
31. 毒樹果實理論
答：
是英美法系中的一項法律原則,比喻違法取得的證據(毒樹)所衍生出的次要證據(毒果)同樣不具證據能力,不得在法庭上使用,核心是防止非法搜查或取證行為的擴散,確保證據的合法性,即使衍生證據本身是合法取得的,也因其來源不潔而被排除,這填補了早期證據排除法則的不足。

[Type:簡答題|Category:專業]
32. 勤務裝備攜行規定
答：
1、執勤人員攜行器械,裝備原則如下:
(1)無械彈室(庫)值班:電擊棒(器)或警棍或防護刑噴霧器執勤,並配戴無線電對講機一台及密錄器一具。
(2)設有械彈室(庫)值班:值班(兼警衛)攜行手槍一支執勤,並配戴無線電對講機一台及密錄器一具。
2、下列各款裝備之攜行原則,由各機關(構)考量轄區特性、勤(業)務需求、任務特性及配備數量等自行訂定之:
(1)勤務腰帶。
(2)防彈背心。
(3)救生衣。
(4)防護頭盔。
(5)反光背心。
(6)蒐證器材。
(7)觀測器材。
3、可變更器械及裝備攜行種類權責為何人:
其他勤務:由機關(構)首長視勤務性質、勤務地點及事實需要決定器械及裝備攜行種類。

[Type:簡答題|Category:法律]
33. 依法執行職務遭侮辱或不當肢體行為時之處置
答：
1、法令依據:
(1)刑法第135、136及140條
(2)海岸巡防機關器械使用條例
2、作業內容:
(1)海巡機關人員依法執行職務時,遭侮辱或不當肢體行為時,應全程錄音、錄影(運用執檢區港區監控系統或其他蒐證器材,全程實施蒐證,蒐證時應有警戒人員維護安全)。
(2)立即通報岸巡隊派遣機動兵力,有效形成優勢,制止其不當行為,並同時通報所在地警察機關,支援協處。
(3)如無法即時制止其不當行為時,海巡機關人員已陷入危害中時,應依海岸巡防機關器械使用條例,使用器械反制,並持續通報優勢機動兵力支援,以保護自身安全。另應注意海岸巡防機關器械使用條例規定,使用器械時,應基於事實需要,合理審慎使用器械,不得逾越必要程度,如非情況急迫,應注意勿傷及致命之部位。
(4)發生聚眾妨害公務之情形時,機動應變兵力應管制現場,防止情勢擴大,並將首謀及下手實施強暴脅迫者,立即逮捕,以控制情勢。
(5)逮捕侮辱、施強暴脅迫或聚眾妨礙公務者,並立即實施詢問,將相關事證依刑法135、136及140 條移送檢察機關依法辦理。
(6)現場如有人員受傷,應立即送醫及驗傷,以作為相關事證。
注意事項:
蒐證人員應注意自身安全,旁邊應有警戒人員維護安全,以免遭受攻擊。

[Type:簡答題|Category:專業]
34. 海洋委員會海巡署船舶疑似私運高經濟價值水產品之處置要點
答：
壹、法令依據
一、漁業法第65條第9款及其施行細則第33條第1款。
二、海關緝私條例第3條、第27條、第36條第1項、第3項。
三、行政罰法第34條第1項第1款、第2項。
貳、作業內容
安檢人員發現船舶載運高經濟價值水產品(例如:龍蝦、午仔魚、黃魚、白帶魚等),並經詢問船長聲稱為「魚餌」使用或其他運送違常情形,相關處置作法如下:
一、巡防區
(一)各巡防區統合指揮轄屬岸巡、海巡、查緝隊執行類案之查緝工作,以全面防堵不法情事。
(二)要求雷達作業人員針對是類船舶出港後全程鎖定目標,通報線上巡防艇實施海上查緝。
(三)將該航次雷達航跡及安全檢查相關佐證,提供轄屬岸巡隊、海巡隊及查緝隊辦理後續追查。
二、港口安檢
(一)船舶出港前
1、勸導船長(主)不應從事違法行為。
2、通報主管機關(漁業署及關務署)至現場本於權責審認有無構成違法及制止船舶出港或扣押(留)、封存物品之必要,相關審認結果認違法屬實,製成書面紀錄現場(或傳真或電子郵件等方式)交付安檢所,本署安檢人員即依行政罰法第34條第1項第1款規定,對於「現行違反行政法上義務」之行為人為即時制止,完備蒐證程序後,函送主管機關(漁業署及關務署)裁罰。
3、倘主管機關(漁業署及關務署)未至現場處置或無法判定違法屬實,且船方執意載運「水產品」出港之處置作為:
(1)漁船
填寫「漁船出港檢查調查表」(附件1)記錄船長(主)陳述魚餌種類與數量、漁具、漁撈設備、作業漁區及作業日數,並執行檢查、拍照及丈量等蒐證工作(應註明魚餌外包裝、保存方式、魚餌狀況等)。
(2)其他船舶
甲、填具「船舶出港檢查調查表」(附件2),詳實記錄貨物品項及船長(主)陳述意見(含數量、重量、運送目的地、託運人及收貨人等)等,並予船長(主)簽名,若拒絕簽名於該欄位註明。
乙、對於船舶及貨物實施檢查、記錄、丈量、蒐證(拍照、錄影)。
(3)船舶出港後,即回報巡防區相關資訊,以利後續查緝部署。
(二)船舶返港後
1、漁船
(1)安檢所依「漁船返港檢查調查表」(附件3)記錄船長(主)陳述漁撈作業情形,針對魚餌剩餘量、漁貨、漁具及漁撈設備使用情形執行檢查、拍照及丈量等蒐證工作,並製作筆錄。
(2)於安檢後填具「非漁業行為諮詢表」(附件4)予船長(主)簽名,若拒絕簽名於該欄位註明。
(3)蒐整出港前及返港後之相關資料,函送主管機關(漁業署及關務署)裁處。
2、其他船舶
(1)船舶進港靠泊前開始全程蒐證錄影,於安檢後填具「船舶返港檢查調查表」(附件5)予船長(主)簽名,若拒絕簽名於該欄位註明,另由岸巡隊另填具「判定結果表」(附件6)。
(2)蒐整出港前及返港後之相關資料(含筆錄、貨物清單、水產試驗所鑑定資料、雷達航跡圖等),函送關務署裁處。
三、海上查緝
(一)預置能量部署監控
1、線上巡防艇獲報是類船舶欲準備報關出港前,即前往貨物接駁熱區海域先行預置,並以艇上雷達、瞭望結合岸際監控能量搜尋、鎖定可能接駁目標船,於是類船舶離港後,即保持適當距離嚴密監控與蒐證。
2、如發現疑有併靠接駁情事,隨即登檢帶案(全程蒐證),並將相關事證函(移)送主管(司法)機關裁處。
(二)落實緊急出勤機制線上巡防艇因執行其他勤務無法實施監控及查緝,應依艦隊分署「艦船艇緊急出勤應變機制策進作法」,調度在港待命艇緊急出勤支援查緝行為。
(三)依況彈性調整勤務接獲走私情資後,評估海象調整適當巡防艦艇執勤,以利海象不佳時,仍可有效應處狀況。
(四)協同執法共同查緝
倘發現違法或可疑目標往大陸方向逃逸且追緝不及,應透過「兩岸協同執法機制」聯繫陸方執法單位共同查緝。
五、情蒐偵查
(一)情資蒐報 掌握轄區注偵船舶動態,如蒐獲疑似走私高經濟價值水產品情資,供案件查處運用。
(二)主動查處
1、船舶進港後應針對船長等涉案人進行訪談筆錄,以及調閱VDR(VMS或AIS)、雷達等航行紀錄,並依所涉法令(規)函送主管機關(漁業署及關務署)裁處。
2、倘發現涉及刑事不法,由巡防區統合轄內岸巡隊、海巡隊及查緝隊共同偵辦,並依本署常用勤務執行標準作業程序彙編「走私案件偵辦」流程(SOP)調查,並報請地檢署檢察官偵辦。
五、注意事項
(一)執行勤務時,特須注意全程蒐證,將相關事證函送主管機關(漁業署及關務署)裁處,倘涉及刑事案件,併案移送檢察機關。
(二)安檢時應針對船載貨品,確認其品項及種類,並詳實記錄,若船載貨品數量龐大時,可實施抽檢,以單一箱次(樣品)完成採證、秤重(須去除冰、水)及影像存證等工作,再依現場所載貨品完成數量推估,另前述影像存證時,應將涉案之船體併同貨品秤重時錄製。
(三)製作筆錄時,應詢問船長(主)航行運送相關資訊(含貨物流向、託運人等)。

[Type:簡答題|Category:法律]
35. 漁船(筏)逃避或拒絕安檢之處置
答：
1、法令依據:
(1)國家安全法第5、14條及其施行細則第22、23及24條。
(2)海岸巡防法第3、4、5、6及7條。行政罰法第26條第1項、第2項。
2、作業內容:
(1)發動檢查以手勢、警示燈、紅色旗幟、哨音或其他輔助方式告知、警示船筏泊停於執檢區,接受檢查。
(2)應全程錄音、錄影(運用執檢區港區監控系統或其他蒐證器材,全程實施蒐證【錄音、錄影】,保全證據)。
(3)經發動檢查,船舶有拒絕或逃避接受檢查行為時,仍應持續發動檢查,告知船長立即停船受檢。
(4)出港船筏拒絕檢查,通報雷哨鎖定及海巡艦艇查緝;進港船筏拒絕檢查,通報港巡、監卸人員或機動兵力前往支援,並記錄於安檢資訊系統及回報岸巡隊。
(5)查獲該船後,其如無正當理由,則涉及違反國家安全法第14條及海岸巡防法第6條第3項規定,此時應依行政罰法第26條第1項、第2 項規定之刑事先行原則處理。
(6)處置時特須注重全程錄音、錄影之蒐證作為,以作為後續偵辦作業之依據。
注意事項:
1、安檢人員發動檢查位置應在港區監視系統可涵蓋範圍內,若無港區監視系統,應以蒐證器材代替,避免無法舉證。
2、行政罰法第26條第1項前段「一行為同時觸犯刑事法律及違反行政法上義務規定者,依刑事法律處罰之。」同條第2項「前項行為如經不起訴處分、緩起訴處分確定或為無罪、免訴、不受理、不付審理、不付保護處分、免刑、緩刑之裁判確定者,得依違反行政法上義務規定裁處之。」

[Type:簡答題|Category:法律]
36. 風災期間地方應變中心已公告禁止限制區域,所轄港區在其公告範圍內,倘有船長告知因港區設備不足,欲至他港進行防颱作業,應如何應處?
答：
1、告知相關規定。
2、請派駐地方應變中心聯絡官向指揮官報告,並請指揮官依權責裁定。
3、倘該船出港,應落實掌握該船動態,並告知其目的港安檢所備便。
4、倘地方應變中心指揮官否決其出港後,該船仍執意出港,則於以勸導必要時開立勸導單及舉發書並函送主管機關。

[Type:簡答題|Category:專業]
37. 岸巡隊勤務部署原則為何？
答：
1、拘束點：狀況初期派兵至岸際監控不法，運用地形先期拘束，俾後續緝捕任務。
2、緝捕點：在目標已遭岸際雷達並預警通報狀況下，機動兵力到答岸際實施緝捕作為。
3、攔截點：因應不法於岸際上岸，部署兵力於可能逃逸路線開設攔截點。
4、管制哨：於外側重要聯外道路，設管制哨，實施道路人車管制，藉以避免不法集團接應逃竄。
5、掃蕩區：藉前述勤務部署作為，完成封鎖、隔離等手段後，投入到達優勢兵力掃蕩殘餘不法。

`;

// 定義流程圖資料 (對應第16題)
// 根據 PDF 內容製作 (修正版，使用 Mermaid)
const diagramQ16 = `
flowchart TD
    %% 設定基本樣式
    classDef default fill:#fff,stroke:#333,stroke-width:1px;
    classDef startNode fill:#e1f5fe,stroke:#01579b,stroke-width:2px;
    classDef endNode fill:#ffebee,stroke:#b71c1c,stroke-width:2px;

    Start{{"颱風或天候惡劣時"}}:::startNode
    
    Area_No["未劃定警戒區域"]
    Area_Yes["經縣(市)政府公告劃<br>定警戒區域"]
    
    Action_Left("對岸際、港口逗留觀浪、撿<br>拾漂流木或從事釣魚等活<br>動之民眾，衡量當時客觀情<br>狀(明白而立即危險)有急<br>迫危險，符合行政執行法第<br>36、37及39條，得採取即<br>時強制手段禁止其進入或<br>命其離去，惟仍應注意比例<br>原則之適用，並全程錄音<br>(影)。")
    
    Sub_Violate["若警戒區已拉設封鎖<br>線，民眾未取得通行<br>證仍執意進入等明顯<br>違規態樣。"]
    Sub_NoPass["針對未取得通行<br>證而欲進入之民<br>眾。"]
    Sub_LegalEntry["地方政府劃定警戒區前民眾<br>已合法進入，或不確定民眾<br>係於劃定警戒區後未取得通<br>行證進入。"]
    
    Advice["可適當以言語或書面進行勸導。"]
    
    Final_Action("應即開立舉發單，並採取直接強制手段禁止其進入或命其<br>離去，全程錄音 (影)。"):::endNode

    %% 連線邏輯 (Connections)
    Start --> Area_No
    Start --> Area_Yes
    
    Area_No --> Action_Left
    
    Area_Yes --> Sub_Violate
    Area_Yes --> Sub_NoPass
    Area_Yes --> Sub_LegalEntry
    
    Sub_Violate --> Final_Action
    Sub_NoPass --> Advice
    Sub_LegalEntry --> Advice
    
    Advice -- "執意進入或逗留" --> Final_Action
`;

// 定義流程圖資料 (對應第33題)
// 根據 flowchart33.html 內容製作
const diagramQ33 = `
flowchart TD
    %% 定義節點樣式
    classDef default fill:#fff,stroke:#333,stroke-width:1px;
    classDef startNode fill:#e1f5fe,stroke:#01579b,stroke-width:2px;
    classDef endNode fill:#ffebee,stroke:#b71c1c,stroke-width:2px;

    %% 節點內容 (Node Definitions)
    %% {{ }} 代表六角形
    Start{{"依法執行職務遭侮<br>辱或不當肢體行為<br>時之處置"}}:::startNode

    CoastGuard["岸巡隊"]
    Police["所在地警察機<br>關支援協處"]
    Evidence["全程蒐證並制止"]

    MobileForce["派遣機動兵<br>力，形成優勢"]
    Control["管制現場"]
    Counter["無法制止時即時反制"]

    Arrest["逮捕侮辱、施強暴脅迫<br>或聚眾妨礙公務<br>者，移送法辦"]

    %% ( ) 代表圓角矩形/橢圓
    Medical("將傷患送醫及驗傷<br>以作為相關事證"):::endNode

    %% 連線邏輯 (Connections)
    %% 左、中、右 分支
    Start -- "通報" --> CoastGuard
    Start --> Evidence
    Start -- "通報" --> Police

    %% 左側流程
    CoastGuard --> MobileForce
    MobileForce --> Control
    MobileForce --> Counter

    %% 中間流程
    Evidence --> Counter
    Counter --> Arrest

    %% 匯聚到逮捕
    Control --> Arrest
    Police --> Arrest

    %% 最後步驟
    Arrest ~~~ Medical
`;

let questionBank = [];
let quizQueue = []; // 用於隨機測驗的題目佇列
let currentQuizTotal = 0; // 當前篩選條件下的總題數
let currentQ = null;
let currentIndex = -1; // 當前在 questionBank 中的 index

// 初始化：解析題庫
window.onload = function() {
    parseQuestionBank();
    updateStats();
    // 注入流程圖到第16題 (索引15)
    if (questionBank.length > 15) {
        questionBank[15].diagram = diagramQ16;
    }
    // 注入流程圖到第33題 (索引32)
    if (questionBank.length > 32) {
        questionBank[32].diagram = diagramQ33;
    }
    document.getElementById('btnImport').className = "btn btn-success";
    document.getElementById('statsArea').style.display = 'block';
};

// 解析題庫 (修正版，支援 Category 標籤)
function parseQuestionBank() {
    const questions = rawDataString.split('[Type:');
    questionBank = [];
    
    questions.forEach(block => {
        if (!block.trim()) return;
        
        let typeEnd = block.indexOf(']');
        let typeInfo = block.substring(0, typeEnd);
        let content = block.substring(typeEnd + 1).trim();
        
        // 解析類型與分類 [Type:簡答題|Category:法律]
        let type = "未分類";
        let category = "一般";
        
        if (typeInfo.includes('|Category:')) {
            const parts = typeInfo.split('|Category:');
            type = parts[0];
            category = parts[1];
        } else {
            type = typeInfo; // 向下相容舊格式
        }
        
        // 分割題目與答案 (找 "答：")
        let parts = content.split('答：');
        if (parts.length >= 2) {
            let qText = parts[0].trim();
            let aText = parts.slice(1).join('答：').trim();
            
            questionBank.push({
                type: type,
                category: category,
                q: qText,
                a: aText,
                diagram: null // 預設無圖
            });
        }
    });
}

function updateStats() {
    document.getElementById('countTotal').innerText = questionBank.length;
}

// 檢視完整題庫功能
document.getElementById('btnReview').addEventListener('click', () => {
    document.getElementById('statsArea').style.display = 'none';
    document.getElementById('quizArea').style.display = 'none';
    document.getElementById('controlPanel').style.display = 'none';
    document.getElementById('reviewArea').style.display = 'block';

    renderReviewList();
    
    mermaid.init();
});

// 渲染列表 (依據篩選條件)
function renderReviewList() {
    const reviewContent = document.getElementById('reviewContent');
    reviewContent.innerHTML = ''; 

    // 取得當前選擇的篩選器
    const filterVal = document.querySelector('input[name="catFilter"]:checked').value;

    if (questionBank.length === 0) {
        reviewContent.innerHTML = '<p class="text-center text-muted">目前沒有題目資料。</p>';
        return;
    }

    questionBank.forEach((q, index) => {
        // 篩選邏輯
        if (filterVal !== 'all' && q.category !== filterVal) {
            return;
        }

        const itemDiv = document.createElement('div');
        itemDiv.className = 'card mb-3 shadow-sm review-item';
        itemDiv.setAttribute('data-id', index);
        itemDiv.setAttribute('data-cat', q.category);
        
        // 決定 Badge 顏色
        let badgeClass = "bg-secondary";
        if (q.category === "法律") badgeClass = "bg-law";
        if (q.category === "專業") badgeClass = "bg-pro";

        let diagramHtml = '';
        if (q.diagram) {
            diagramHtml = `
                <div class="diagram-wrapper">
                    <div class="zoom-controls">
                        <label class="small text-muted"><i class="bi bi-zoom-in"></i> 圖表縮放: </label>
                        <input type="range" min="0.5" max="2" step="0.1" value="1" oninput="resizeDiagram(this, ${index})">
                    </div>
                    <div class="mermaid" id="mermaid-${index}">
                        ${q.diagram}
                    </div>
                </div>
            `;
        }

        itemDiv.innerHTML = `
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <h5 class="review-q">
                        <span class="badge ${badgeClass} badge-cat">${q.category}</span>
                        <span class="badge bg-light text-dark border me-1">Q${index + 1}</span> 
                        <span class="badge bg-warning text-dark badge-type me-2">${q.type}</span>
                    </h5>
                    <button class="btn btn-sm btn-outline-primary btn-toggle-ans" onclick="toggleAnswer(${index})">
                        👁️ 顯示/隱藏答案
                    </button>
                </div>
                <p class="card-text fw-bold mt-2" style="white-space: pre-wrap;">${q.q}</p>
                
                ${diagramHtml}

                <div id="ans-container-${index}" class="review-a-container" style="display:none;">
                    <div class="badge bg-secondary mb-2">標準答案</div>
                    <div class="review-a-text" id="std-ans-${index}">${q.a}</div>
                </div>

                <div id="practice-container-${index}" class="review-practice-area">
                    <label class="form-label text-muted small">✍️ 自我練習區：</label>
                    <textarea class="form-control mb-2" id="practice-input-${index}" rows="4" placeholder="在此輸入您的答案..."></textarea>
                    <button class="btn btn-success btn-sm w-100" onclick="checkPractice(${index})">✅ 送出比對</button>
                    <div id="practice-result-${index}" class="diff-result-mini" style="display:none;"></div>
                </div>
            </div>
        `;
        reviewContent.appendChild(itemDiv);
    });
    
    // 重新初始化 Mermaid (針對新插入的 DOM)
    setTimeout(() => {
       mermaid.init();
    }, 100);
}

// 篩選器觸發
window.filterQuestions = function(val) {
    renderReviewList();
}

window.resizeDiagram = function(rangeInput, index) {
    const scale = rangeInput.value;
    const diagramDiv = document.getElementById(`mermaid-${index}`);
    if (diagramDiv) {
        diagramDiv.style.transform = `scale(${scale})`;
    }
};

window.toggleAnswer = function(index) {
    const ansContainer = document.getElementById(`ans-container-${index}`);
    const practiceContainer = document.getElementById(`practice-container-${index}`);
    
    if (ansContainer.style.display === 'none') {
        ansContainer.style.display = 'block';
        practiceContainer.style.display = 'none'; 
    } else {
        ansContainer.style.display = 'none';
        practiceContainer.style.display = 'block'; 
    }
};

window.checkPractice = function(index) {
    const userAns = document.getElementById(`practice-input-${index}`).value;
    const stdAns = questionBank[index].a;
    const resultDiv = document.getElementById(`practice-result-${index}`);
    
    if (!userAns.trim()) {
        alert("請先輸入答案！");
        return;
    }

    const diffHtml = computeDiff(stdAns, userAns);
    resultDiv.innerHTML = `<strong>比對結果：</strong><br>${diffHtml}`;
    resultDiv.style.display = 'block';
};

let isAllVisible = false;
document.getElementById('btnToggleAll').addEventListener('click', () => {
    isAllVisible = !isAllVisible;
    // 只對目前可見的題目操作
    document.querySelectorAll('.review-item').forEach(item => {
        const index = item.getAttribute('data-id');
        const ansContainer = document.getElementById(`ans-container-${index}`);
        const practiceContainer = document.getElementById(`practice-container-${index}`);
        if(isAllVisible) {
            ansContainer.style.display = 'block';
            practiceContainer.style.display = 'none';
        } else {
            ansContainer.style.display = 'none';
            practiceContainer.style.display = 'block';
        }
    });
});

document.getElementById('btnBackFromReview').addEventListener('click', () => {
    document.getElementById('reviewArea').style.display = 'none';
    document.getElementById('controlPanel').style.display = 'block';
    
    // 返回時若有進行中的測驗則顯示測驗區，否則顯示主畫面
    if (quizQueue.length < currentQuizTotal && currentQ) {
        document.getElementById('quizArea').style.display = 'block';
    } else {
        // 如果沒有進行中的測驗，顯示主選單與統計
        showMainMenu();
        document.getElementById('statsArea').style.display = 'block';
    }
});

// 重設功能
document.getElementById('btnReset').addEventListener('click', () => {
    if(confirm('確定要全部重設並重新開始測驗嗎？')) {
        quizQueue = [];
        currentIndex = -1;
        currentQ = null;
        
        document.getElementById('userAnswer').value = '';
        document.getElementById('userAnswer').disabled = false;
        document.getElementById('resultArea').style.display = 'none';
        document.getElementById('btnSubmit').style.display = 'block';
        
        // 恢復到初始狀態：顯示主選單，隱藏分類選單與測驗區
        showMainMenu();
        document.getElementById('statsArea').style.display = 'block';
        document.getElementById('quizArea').style.display = 'none';
    }
});

// 切換至分類選擇介面
document.getElementById('btnStartMode').addEventListener('click', () => {
    if (questionBank.length === 0) {
        alert("題庫為空，請檢查解析！");
        return;
    }
    document.getElementById('mainMenu').style.display = 'none';
    document.getElementById('categoryMenu').style.display = 'block';
});

// 顯示主選單 (Helper)
function showMainMenu() {
    document.getElementById('mainMenu').style.display = 'flex';
    document.getElementById('categoryMenu').style.display = 'none';
}

// 開始測驗 (接收 scope 參數)
window.startQuiz = function(scope) {
    // 建立題目佇列 (Filtered Queue)
    quizQueue = [];
    questionBank.forEach((q, index) => {
        if (scope === 'all' || q.category === scope) {
            quizQueue.push(index);
        }
    });

    if (quizQueue.length === 0) {
        alert("選擇的分類沒有題目！請選擇其他範圍。");
        return;
    }

    // 隨機洗牌
    for (let i = quizQueue.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [quizQueue[i], quizQueue[j]] = [quizQueue[j], quizQueue[i]];
    }
    
    // 設定本輪總題數
    currentQuizTotal = quizQueue.length;

    // 切換介面：隱藏選單，顯示測驗區
    document.getElementById('categoryMenu').style.display = 'none';
    document.getElementById('statsArea').style.display = 'none';
    document.getElementById('quizArea').style.display = 'block';
    
    // 開始第一題
    nextQuestion();
};

function nextQuestion() {
    if (quizQueue.length === 0) {
        alert("恭喜！您已完成本範圍內的所有題目！");
        // 完成後回到主選單
        showMainMenu();
        document.getElementById('quizArea').style.display = 'none';
        document.getElementById('statsArea').style.display = 'block';
        return;
    }

    // 從佇列尾部取出一個索引 (不重複)
    currentIndex = quizQueue.pop();
    currentQ = questionBank[currentIndex];

    document.getElementById('qCategoryBadge').innerText = currentQ.category;
    // 設定顏色
    let catClass = "bg-secondary";
    if (currentQ.category === "法律") catClass = "bg-law";
    if (currentQ.category === "專業") catClass = "bg-pro";
    document.getElementById('qCategoryBadge').className = `badge badge-cat me-1 ${catClass}`;

    document.getElementById('qTypeBadge').innerText = currentQ.type;
    
    // 計算已完成題數
    let doneCount = currentQuizTotal - quizQueue.length;
    document.getElementById('qProgress').innerText = `進度: ${doneCount} / ${currentQuizTotal}`;
    
    document.getElementById('questionText').innerText = currentQ.q;
    document.getElementById('userAnswer').value = '';
    document.getElementById('userAnswer').disabled = false;
    document.getElementById('resultArea').style.display = 'none';
    document.getElementById('btnSubmit').style.display = 'block';
    
    document.getElementById('quizArea').scrollIntoView({ behavior: 'smooth' });
}

document.getElementById('btnNext').addEventListener('click', nextQuestion);

document.getElementById('btnSubmit').addEventListener('click', () => {
    let userAns = document.getElementById('userAnswer').value;
    let stdAns = currentQ.a;

    if (!userAns.trim()) {
        if(!confirm("您尚未作答，確定要送出嗎？")) return;
    }

    document.getElementById('resStandard').innerText = stdAns;
    document.getElementById('resUser').innerText = userAns;

    let diffHtml = computeDiff(stdAns, userAns);
    document.getElementById('resDiff').innerHTML = diffHtml;

    document.getElementById('resultArea').style.display = 'block';
    document.getElementById('userAnswer').disabled = true;
    document.getElementById('btnSubmit').style.display = 'none';
    document.getElementById('resultArea').scrollIntoView({ behavior: 'smooth' });
});

function isPunctuationOnly(str) {
    return /^([，。、；：？！「」『』().,;?!:"'\s\n\r]+)$/.test(str);
}

function computeDiff(std, user) {
    if (!user.trim()) return '<span class="text-danger fw-bold">❌ 未回答</span>';

    let dmp = new diff_match_patch();
    let diffs = dmp.diff_main(std, user);
    dmp.diff_cleanupSemantic(diffs);

    let html = '';
    diffs.forEach(part => {
        let type = part[0];
        let text = part[1];

        if (type === 0) {
            html += `<span>${text}</span>`;
        } else {
            if (isPunctuationOnly(text)) {
                 html += `<span>${text}</span>`;
            } else {
                if (type === 1) { 
                    html += `<span class="diff-ins">${text}</span>`;
                } else if (type === -1) { 
                    html += `<span class="diff-missing">${text}</span>`;
                }
            }
        }
    });

    return html;
}
</script>

</body>
</html>